<!DOCTYPE html>
<html lang="pt-PT">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>integra+ Dashboard P√∫blico</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    body{margin:0;font-family:Inter,sans-serif;background:#0b1020;color:#eaf0ff;}
    .board-header{display:flex;justify-content:space-between;align-items:center;margin:20px;}
    .kanban-board{display:grid;grid-template-columns:repeat(auto-fit, minmax(300px, 1fr));gap:20px;margin:20px;}
    .kanban-column{background:#121935;border-radius:14px;padding:15px;display:flex;flex-direction:column;}
    .kanban-tasks{flex:1;min-height:100px;padding:10px;background:rgba(0,0,0,.05);border-radius:8px;}
    .kanban-task{background:#161e42;padding:12px;margin-bottom:10px;border-radius:10px;cursor:grab;}
    .kanban-task .actions{margin-top:8px;display:flex;gap:6px;}
    .kanban-task .actions button{background:none;border:none;color:#b9c2e0;cursor:pointer;font-size:14px;}
    .add-task{margin-top:15px;padding-top:15px;border-top:1px dashed rgba(255,255,255,.1);}
    .add-task input{width:100%;box-sizing: border-box;padding:8px;margin-bottom:8px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.2);border-radius:8px;color:#fff;}
    .add-task button{width:100%;padding:10px 14px;border:none;border-radius:8px;background:#6ee7ff;color:#000;font-weight:600;cursor:pointer;}
    .kaizen-ia{margin:20px;background:#161e42;padding:15px;border-radius:12px;}
    .kaizen-ia h3{margin-top:0;color:#6ee7ff;}
    .kaizen-ask{margin-top:10px;display:flex;gap:10px;}
    .kaizen-ask input{flex:1;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.05);color:#fff;}
    .kaizen-ask button{padding:8px 14px;border:none;border-radius:8px;background:#6ee7ff;color:#000;font-weight:600;cursor:pointer;}
    .kaizen-ask button:disabled{background-color:#555; cursor:not-allowed;}
    .dragging { opacity: 0.5; }
  </style>
</head>
<body>
  <div class="board-header">
    <div>
      <p style="margin:0;font-size:14px;color:#b9c2e0">Quadro P√∫blico</p>
      <h1>Quadro de Opera√ß√µes</h1>
    </div>
  </div>

  <div class="kanban-board" id="kanban-board">
    <!-- As colunas s√£o geradas dinamicamente -->
  </div>

  <div class="kaizen-ia">
    <h3>Recomenda√ß√µes da IA Kaizen:</h3>
    <div id="kaizen-suggestions"><p>A carregar recomenda√ß√µes...</p></div>
    <div class="kaizen-ask">
      <input type="text" id="kaizen-question" placeholder="Pergunte algo √† IA...">
      <button id="ask-kaizen-btn">Perguntar</button>
    </div>
    <div id="kaizen-answer" style="margin-top:10px;color:#b9c2e0;white-space:pre-wrap;"></div>
  </div>

  <!-- Firebase SDKs Modulares (vers√£o mais recente) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, doc, onSnapshot, addDoc, updateDoc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- ELEMENTOS DO DOM E ESTADO DA APLICA√á√ÉO ---
    const kanbanBoard = document.getElementById('kanban-board');
    const kaizenSuggestions = document.getElementById('kaizen-suggestions');
    const kaizenAnswer = document.getElementById('kaizen-answer');
    const askKaizenBtn = document.getElementById('ask-kaizen-btn');
    
    let db, auth;
    let currentTasks = [];
    let draggedItem = null;
    const statuses = { 'todo': 'A Fazer', 'doing': 'A Executar', 'done': 'Feito' };

    // --- CONFIGURA√á√ÉO E INICIALIZA√á√ÉO DO FIREBASE ---
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-kanban-app';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    function initializeAppAndAuth() {
        if (Object.keys(firebaseConfig).length === 0) {
            kanbanBoard.innerHTML = "<p>Erro: Configura√ß√£o do Firebase n√£o encontrada.</p>";
            return;
        }
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            buildKanbanColumns(); // Constr√≥i a estrutura HTML
            setupEventListeners(); // Configura os eventos de clique e arrastar
            
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    loadTasks(); // Se o utilizador estiver autenticado, carrega as tarefas
                } else {
                    // Se n√£o, tenta autenticar-se (com token ou anonimamente)
                    await (initialAuthToken ? signInWithCustomToken(auth, initialAuthToken) : signInAnonymously(auth));
                }
            });
        } catch (error) {
            console.error("Erro na inicializa√ß√£o do Firebase:", error);
            kanbanBoard.innerHTML = `<p>Erro ao inicializar a aplica√ß√£o: ${error.message}</p>`;
        }
    }
    
    // --- FUN√á√ïES DE DADOS (FIRESTORE) ---
    function getTasksCollectionRef() {
        return collection(db, `artifacts/${appId}/public/data/tasks`);
    }

    function loadTasks() {
        const q = query(getTasksCollectionRef(), orderBy("createdAt", "desc"));
        onSnapshot(q, (snapshot) => {
            currentTasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderTasks(currentTasks);
        }, (error) => console.error("Erro ao carregar tarefas:", error));
    }
    
    async function addTask(status) {
        const titleInput = document.getElementById(`new-task-title-${status}`);
        const title = titleInput.value.trim();
        if (!title) {
            alert('O t√≠tulo √© obrigat√≥rio.');
            return;
        }
        const responsibleInput = document.getElementById(`new-task-responsible-${status}`);
        const deadlineInput = document.getElementById(`new-task-deadline-${status}`);
        
        await addDoc(getTasksCollectionRef(), {
            title,
            responsible: responsibleInput.value.trim() || null,
            deadline: deadlineInput.value.trim() || null,
            status,
            createdAt: new Date().toISOString()
        });
        
        titleInput.value = '';
        responsibleInput.value = '';
        deadlineInput.value = '';
    }

    async function editTask(id, currentTitle) {
        const newTitle = prompt('Editar t√≠tulo da tarefa:', currentTitle);
        if (newTitle && newTitle.trim() && newTitle.trim() !== currentTitle) {
            await updateDoc(doc(getTasksCollectionRef(), id), { title: newTitle.trim() });
        }
    }

    async function deleteTask(id) {
        if (confirm('Tem a certeza de que quer apagar esta tarefa?')) {
            await deleteDoc(doc(getTasksCollectionRef(), id));
        }
    }
    
    // --- RENDERIZA√á√ÉO E UI ---
    function buildKanbanColumns() {
        kanbanBoard.innerHTML = '';
        for (const status in statuses) {
             const columnEl = document.createElement('div');
            columnEl.classList.add('kanban-column');
            columnEl.innerHTML = `
                <h2>${statuses[status]}</h2>
                <div class="kanban-tasks" data-status="${status}"></div>
                <div class="add-task">
                    <input type="text" placeholder="Tarefa..." id="new-task-title-${status}">
                    <input type="text" placeholder="Respons√°vel..." id="new-task-responsible-${status}">
                    <input type="text" placeholder="Prazo (DD/MM/AAAA)..." id="new-task-deadline-${status}">
                    <button data-action="add-task" data-status="${status}">Adicionar</button>
                </div>`;
            kanbanBoard.appendChild(columnEl);
        }
    }
    
    function renderTasks(tasks) {
      document.querySelectorAll('.kanban-tasks').forEach(col => col.innerHTML = '');
      tasks.forEach(task => {
        const column = document.querySelector(`.kanban-tasks[data-status="${task.status}"]`);
        if(column) {
            const el = document.createElement('div');
            el.classList.add('kanban-task');
            el.setAttribute('data-id', task.id);
            el.setAttribute('draggable', 'true');
            el.innerHTML = `
              <strong>${task.title}</strong><br>
              <small>${task.responsible || 'Sem respons√°vel'} - ${task.deadline || 'Sem prazo'}</small>
              <div class="actions">
                <button data-action="edit-task" data-id="${task.id}" data-title="${task.title}">‚úèÔ∏è</button>
                <button data-action="delete-task" data-id="${task.id}">üóëÔ∏è</button>
              </div>`;
            column.appendChild(el);
        }
      });
      updateKaizenSuggestions(tasks);
    }
    
    // --- GEST√ÉO DE EVENTOS ---
    function setupEventListeners() {
        kanbanBoard.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (!button) return;
            const { action, status, id, title } = button.dataset;

            if (action === 'add-task') addTask(status);
            if (action === 'edit-task') editTask(id, title);
            if (action === 'delete-task') deleteTask(id);
        });

        kanbanBoard.addEventListener('dragstart', (e) => {
            if (e.target.classList.contains('kanban-task')) {
                draggedItem = e.target;
                setTimeout(() => draggedItem.classList.add('dragging'), 0);
            }
        });
        kanbanBoard.addEventListener('dragend', () => {
            if(draggedItem) {
                draggedItem.classList.remove('dragging');
                draggedItem = null;
            }
        });
        kanbanBoard.addEventListener('dragover', (e) => e.preventDefault());
        kanbanBoard.addEventListener('drop', async (e) => {
            e.preventDefault();
            const targetColumn = e.target.closest('.kanban-tasks');
            if (targetColumn && draggedItem) {
                const newStatus = targetColumn.dataset.status;
                const taskId = draggedItem.dataset.id;
                await updateDoc(doc(getTasksCollectionRef(), taskId), { status: newStatus });
            }
        });
        
        askKaizenBtn.addEventListener('click', askKaizen);
    }

    function updateKaizenSuggestions(tasks){
      // Esta fun√ß√£o n√£o precisa de altera√ß√µes
      kaizenSuggestions.innerHTML = '';
      const todo = tasks.filter(t=>t.status==='todo');
      const doing = tasks.filter(t=>t.status==='doing');
      if(todo.some(t=>!t.responsible)){
        kaizenSuggestions.innerHTML += `<p>‚Ä¢ H√° tarefas sem respons√°vel. Atribua-as para evitar atrasos.</p>`;
      }
      const today = new Date();today.setHours(0,0,0,0);
      const overdue = todo.filter(t=> {
          if (!t.deadline || !t.deadline.includes('/')) return false;
          try {
            const [day, month, year] = t.deadline.split('/');
            return new Date(`${year}-${month}-${day}`) < today;
          } catch { return false; }
      });
      if(overdue.length){
        kaizenSuggestions.innerHTML += `<p><strong>‚Ä¢ Aten√ß√£o:</strong> ${overdue.length} tarefa(s) est√£o atrasadas!</p>`;
      }
      if(doing.length>3 && doing.length>todo.length){
        kaizenSuggestions.innerHTML += `<p>‚Ä¢ H√° muitos itens em andamento. Considere uma reuni√£o para definir prioridades.</p>`;
      }
      if(!kaizenSuggestions.innerHTML){
        kaizenSuggestions.innerHTML = '<p>Nenhuma sugest√£o de momento. Continue assim!</p>';
      }
    }

    // --- SEC√á√ÉO DA IA (N√ÉO MODIFICADA) ---
    async function askKaizen() {
        const question = document.getElementById('kaizen-question').value.trim().toLowerCase();
        if (!question) return;

        kaizenAnswer.textContent = 'A IA est√° a analisar os dados...';
        askKaizenBtn.disabled = true;

        await new Promise(resolve => setTimeout(resolve, 500));

        let responseText = `N√£o tenho a certeza de como ajudar com isso. Tente perguntar sobre:\n‚Ä¢ "quais tarefas est√£o atrasadas?"\n‚Ä¢ "resumo do quadro"\n‚Ä¢ "quem est√° a fazer o qu√™?"\n‚Ä¢ "tarefas sem respons√°vel"`;

        try {
            const todo = currentTasks.filter(t => t.status === 'todo');
            const doing = currentTasks.filter(t => t.status === 'doing');
            const done = currentTasks.filter(t => t.status === 'done');

            const keywords = {
                overdue: ['atrasada', 'atraso', 'prazo'],
                summary: ['resumo', 'geral', 'vis√£o', 'tudo'],
                doing: ['fazendo', 'executando', 'andamento', 'quem'],
                unassigned: ['sem respons√°vel', 'livre', 'dispon√≠vel'],
                done: ['conclu√≠da', 'feita', 'terminada']
            };

            if (keywords.overdue.some(k => question.includes(k))) {
                const today = new Date(); today.setHours(0, 0, 0, 0);
                const overdue = currentTasks.filter(t => {
                    if (t.status === 'done' || !t.deadline || !t.deadline.includes('/')) return false;
                    try {
                        const [day, month, year] = t.deadline.split('/');
                        return new Date(`${year}-${month}-${day}`) < today;
                    } catch { return false; }
                });
                if (overdue.length === 0) {
                    responseText = "Boas not√≠cias! Nenhuma tarefa parece estar atrasada.";
                } else {
                    responseText = `Encontrei ${overdue.length} tarefa(s) atrasada(s):\n` + overdue.map(t => `‚Ä¢ "${t.title}" (Prazo: ${t.deadline})`).join('\n');
                }
            } else if (keywords.summary.some(k => question.includes(k))) {
                 responseText = `Aqui est√° um resumo do quadro:\n- ${todo.length} tarefa(s) por fazer.\n- ${doing.length} tarefa(s) em execu√ß√£o.\n- ${done.length} tarefa(s) j√° conclu√≠das.`;
            } else if (keywords.doing.some(k => question.includes(k))) {
                if (doing.length === 0) {
                    responseText = "Ningu√©m est√° a executar tarefas neste momento.";
                } else {
                    responseText = `Atualmente, ${doing.length} tarefa(s) est√£o em execu√ß√£o:\n` + doing.map(t => `‚Ä¢ "${t.title}" por ${t.responsible || 'Ningu√©m'}`).join('\n');
                }
            } else if (keywords.unassigned.some(k => question.includes(k))) {
                const unassigned = todo.filter(t => !t.responsible);
                if (unassigned.length === 0) {
                    responseText = "Excelente! Todas as tarefas por fazer j√° t√™m um respons√°vel.";
                } else {
                    responseText = `Existem ${unassigned.length} tarefas por fazer que ainda n√£o foram atribu√≠das a ningu√©m.`;
                }
            } else if (keywords.done.some(k => question.includes(k))) {
                 if (done.length === 0) {
                    responseText = "Ainda nenhuma tarefa foi conclu√≠da.";
                } else {
                    responseText = `J√° foram conclu√≠das ${done.length} tarefas. Bom trabalho!`;
                }
            }

            kaizenAnswer.textContent = responseText;

        } catch (error) {
            console.error("Erro na IA local:", error);
            kaizenAnswer.textContent = "Ocorreu um erro ao processar o seu pedido.";
        } finally {
            askKaizenBtn.disabled = false;
        }
    }

    // --- INICIA A APLICA√á√ÉO ---
    initializeAppAndAuth();
  </script>
</body>
</html>

