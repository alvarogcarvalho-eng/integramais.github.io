<script type="module">
    // ####################### Vari√°veis e Refer√™ncias do DOM #######################
    const kanbanView = document.getElementById('kanban-view');
    const reportsView = document.getElementById('reports-view');
    const companyView = document.getElementById('company-view');
    const settingsView = document.getElementById('settings-view');
    const navItems = document.querySelectorAll('.nav-item');
    const kanbanBoard = document.getElementById('kanban-board');
    const messageModal = document.getElementById('message-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalMessage = document.getElementById('modal-message');
    const modalConfirmBtn = document.getElementById('modal-confirm-btn');
    const modalCancelBtn = document.getElementById('modal-cancel-btn');
    const kaizenSuggestions = document.getElementById('kaizen-suggestions');
    const userInfoSpan = document.getElementById('user-info');
    
    let draggedItem = null;
    let authUser = null;
    let tasksCollectionRef = null; // Nova vari√°vel para a refer√™ncia da cole√ß√£o
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    // ####################### Fun√ß√µes de UI e Acessibilidade #######################

    function renderView(viewName) {
        // Oculta todas as visualiza√ß√µes e remove a classe 'active'
        document.querySelectorAll('.other-views').forEach(view => view.style.display = 'none');
        kanbanView.style.display = 'none';
        navItems.forEach(item => item.classList.remove('active'));

        // Exibe a visualiza√ß√£o correta
        const viewToShow = document.getElementById(`${viewName}-view`);
        if (viewToShow) {
            viewToShow.style.display = 'block';
        }
        
        const navItem = document.querySelector(`[data-view="${viewName}"]`);
        if (navItem) {
            navItem.classList.add('active');
        }
    }

    // Adiciona event listeners aos bot√µes de navega√ß√£o
    navItems.forEach(item => {
        const view = item.dataset.view;
        item.addEventListener('click', (e) => {
            e.preventDefault();
            if (view === 'signout') {
                signOutUser();
            } else {
                renderView(view);
            }
        });
    });

    // Fun√ß√£o para mostrar um modal de mensagem ou confirma√ß√£o
    window.showModal = function(title, message, isConfirm = false) {
        return new Promise(resolve => {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            messageModal.style.display = 'flex';
            modalConfirmBtn.textContent = 'OK';
            modalCancelBtn.style.display = 'none';

            if (isConfirm) {
                modalConfirmBtn.textContent = 'Confirmar';
                modalCancelBtn.style.display = 'inline-block';
            }
            
            modalConfirmBtn.onclick = () => {
                messageModal.style.display = 'none';
                resolve(true);
            };
            modalCancelBtn.onclick = () => {
                messageModal.style.display = 'none';
                resolve(false);
            };
        });
    }

    // Fun√ß√£o para mostrar um modal de prompt com campo de texto
    window.showPromptModal = function(title, message, defaultValue = '') {
        return new Promise(resolve => {
            modalTitle.textContent = title;
            modalMessage.textContent = ''; // Limpa a mensagem padr√£o
            const input = document.createElement('input');
            input.type = 'text';
            input.placeholder = message;
            input.value = defaultValue;
            modalContent.insertBefore(input, modalActions);
            
            modalConfirmBtn.textContent = 'Salvar';
            modalCancelBtn.style.display = 'inline-block';
            messageModal.style.display = 'flex';
            
            modalConfirmBtn.onclick = () => {
                messageModal.style.display = 'none';
                input.remove();
                resolve(input.value);
            };
            modalCancelBtn.onclick = () => {
                messageModal.style.display = 'none';
                input.remove();
                resolve(null);
            };
            
            input.focus();
        });
    };

    // Simula√ß√£o da funcionalidade de voz
    const supportsSpeech = 'speechSynthesis' in window && 'SpeechSynthesisUtterance' in window;
    window.speak = function(text, rate=1){
      if(!supportsSpeech || !text) return;
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'pt-BR';
      const pickVoice = () => {
        const voices = speechSynthesis.getVoices();
        const br = voices.find(v => v.lang.toLowerCase().startsWith('pt-br'));
        if(br) u.voice = br;
        speechSynthesis.speak(u);
      };
      if(speechSynthesis.getVoices().length) pickVoice();
      else speechSynthesis.onvoiceschanged = pickVoice;
    }

    window.speakKaizenSuggestions = function(){
        let textToSpeak = 'Recomenda√ß√µes da IA Kaizen. ';
        kaizenSuggestions.querySelectorAll('p').forEach(p => {
            textToSpeak += p.textContent + '. ';
        });
        speak(textToSpeak);
    }
    
    // ####################### Fun√ß√µes de Manipula√ß√£o do DOM #######################
    
    function renderTasks(tasks) {
        const columns = {
            todo: document.querySelector('.kanban-tasks[data-status="todo"]'),
            doing: document.querySelector('.kanban-tasks[data-status="doing"]'),
            done: document.querySelector('.kanban-tasks[data-status="done"]')
        };

        // Limpa todas as colunas
        Object.values(columns).forEach(col => col.innerHTML = '');

        // Preenche as colunas com as tarefas do banco
        tasks.forEach(task => {
            const newTask = document.createElement('div');
            newTask.classList.add('kanban-task');
            newTask.setAttribute('draggable', 'true');
            newTask.setAttribute('data-id', task.id);
            newTask.setAttribute('data-status', task.status);

            const deadlineText = task.deadline ? `Prazo: ${task.deadline}` : 'Prazo: A definir';
            const responsibleText = task.responsible ? `Respons√°vel: ${task.responsible}` : 'Respons√°vel: A definir';
            
            newTask.innerHTML = `
                <strong>${task.title}</strong>
                <div class="meta">
                    <span>${responsibleText}</span>
                    <span>${deadlineText}</span>
                </div>
                <div class="actions">
                    <button onclick="editTaskTitle(this)">‚úèÔ∏è</button>
                    <button class="delete" onclick="deleteTask(this)">üóëÔ∏è</button>
                    <button onclick="openSettings(this)">‚öôÔ∏è</button>
                    <div class="settings-menu" hidden>
                        <button onclick="editTaskResponsible(this)">Atribuir</button>
                        <button onclick="editTaskDeadline(this)">Definir Prazo</button>
                    </div>
                </div>
            `;
            if (columns[task.status]) {
                 columns[task.status].appendChild(newTask);
            }
        });

        updateKaizenSuggestions(tasks);
    }
    
    // ####################### Fun√ß√µes de Intera√ß√£o com Firestore #######################
    
    window.addTask = async function(status) {
        // Agora a vari√°vel `tasksCollectionRef` j√° est√° definida (ou √© null se n√£o estiver autenticado)
        if (!tasksCollectionRef) {
            showModal('Erro', 'Voc√™ precisa estar logado para adicionar tarefas.');
            return;
        }
        
        const titleInput = document.getElementById(`new-task-title-${status}`);
        const responsibleInput = document.getElementById(`new-task-responsible-${status}`);
        const deadlineInput = document.getElementById(`new-task-deadline-${status}`);

        const taskTitle = titleInput.value.trim();
        const taskResponsible = responsibleInput.value.trim();
        const taskDeadline = deadlineInput.value.trim();
        
        if (!taskTitle) {
            showModal('Erro', 'O t√≠tulo da tarefa √© obrigat√≥rio.');
            return;
        }
        
        const newTask = {
            title: taskTitle,
            responsible: taskResponsible || null,
            deadline: taskDeadline || null,
            status: status,
            createdAt: new Date().toISOString()
        };
        
        try {
            // Usa a refer√™ncia da cole√ß√£o que foi definida no `onAuthStateChanged`
            await window.addDoc(tasksCollectionRef, newTask);
            titleInput.value = '';
            responsibleInput.value = '';
            deadlineInput.value = '';
        } catch (error) {
            showModal('Erro ao adicionar tarefa', error.message);
            console.error('Erro ao adicionar tarefa:', error);
        }
    }

    window.updateTask = async function(taskId, newData) {
        if (!authUser) {
            showModal('Erro', 'Voc√™ precisa estar logado para atualizar tarefas.');
            return;
        }
        try {
            const taskDocRef = window.doc(tasksCollectionRef, taskId);
            await window.updateDoc(taskDocRef, newData);
        } catch (error) {
            showModal('Erro ao atualizar tarefa', error.message);
            console.error('Erro ao atualizar tarefa:', error);
        }
    }

    window.deleteTask = async function(button) {
        if (!authUser) {
            showModal('Erro', 'Voc√™ precisa estar logado para deletar tarefas.');
            return;
        }
        const taskId = button.closest('.kanban-task').getAttribute('data-id');
        const confirmDelete = await showModal('Confirma√ß√£o', 'Tem certeza que deseja excluir esta tarefa?', true);
        if (confirmDelete) {
            try {
                const taskDocRef = window.doc(tasksCollectionRef, taskId);
                await window.deleteDoc(taskDocRef);
            } catch (error) {
                showModal('Erro ao deletar tarefa', error.message);
                console.error('Erro ao deletar tarefa:', error);
            }
        }
    }

    window.editTaskTitle = async function(button) {
        const taskElement = button.closest('.kanban-task');
        const taskId = taskElement.getAttribute('data-id');
        const currentTitle = taskElement.querySelector('strong').textContent;
        const newTitle = await showPromptModal('Editar tarefa', 'Novo t√≠tulo:', currentTitle);
        if (newTitle && newTitle.trim() !== '' && newTitle !== currentTitle) {
            await updateTask(taskId, { title: newTitle.trim() });
        }
    }
    
    window.editTaskResponsible = async function(button) {
        const taskElement = button.closest('.kanban-task');
        const taskId = taskElement.getAttribute('data-id');
        const currentResponsible = taskElement.querySelector('.meta span:nth-child(1)').textContent.replace('Respons√°vel: ', '');
        const newResponsible = await showPromptModal('Atribuir', 'Novo respons√°vel:', currentResponsible);
        if (newResponsible && newResponsible.trim() !== '') {
            await updateTask(taskId, { responsible: newResponsible.trim() });
        } else if (newResponsible === '') {
             await updateTask(taskId, { responsible: null });
        }
        button.closest('.settings-menu').hidden = true;
    }

    window.editTaskDeadline = async function(button) {
        const taskElement = button.closest('.kanban-task');
        const taskId = taskElement.getAttribute('data-id');
        const currentDeadline = taskElement.querySelector('.meta span:nth-child(2)').textContent.replace('Prazo: ', '');
        const newDeadline = await showPromptModal('Definir Prazo', 'Novo prazo (DD/MM/AAAA):', currentDeadline);
        if (newDeadline && newDeadline.trim() !== '') {
             await updateTask(taskId, { deadline: newDeadline.trim() });
        } else if (newDeadline === '') {
            await updateTask(taskId, { deadline: null });
        }
        button.closest('.settings-menu').hidden = true;
    }

    window.openSettings = function(button) {
        const menu = button.nextElementSibling;
        const allMenus = document.querySelectorAll('.settings-menu');
        allMenus.forEach(m => {
            if (m !== menu) {
                m.hidden = true;
            }
        });
        menu.hidden = !menu.hidden;
    }
    
    // ####################### L√≥gica do Drag and Drop #######################

    kanbanBoard.addEventListener('dragstart', (e) => {
        if (!authUser) {
             showModal('Erro', 'Voc√™ precisa estar logado para mover tarefas.');
             e.preventDefault();
             return;
        }
        if (e.target.classList.contains('kanban-task')) {
            draggedItem = e.target;
            setTimeout(() => {
                e.target.classList.add('dragging');
            }, 0);
        }
    });

    kanbanBoard.addEventListener('dragend', (e) => {
        if (draggedItem) {
            draggedItem.classList.remove('dragging');
            draggedItem = null;
        }
    });

    kanbanBoard.addEventListener('dragover', (e) => {
        e.preventDefault();
        const target = e.target.closest('.kanban-tasks');
        if (target && draggedItem) {
            const afterElement = getDragAfterElement(target, e.clientY);
            if (afterElement == null) {
                target.appendChild(draggedItem);
            } else {
                target.insertBefore(draggedItem, afterElement);
            }
        }
    });

    kanbanBoard.addEventListener('drop', async (e) => {
        e.preventDefault();
        const targetColumn = e.target.closest('.kanban-tasks');
        if (targetColumn && draggedItem) {
            const newStatus = targetColumn.getAttribute('data-status');
            const taskId = draggedItem.getAttribute('data-id');
            const currentStatus = draggedItem.getAttribute('data-status');

            if (newStatus !== currentStatus) {
                const updateData = { status: newStatus };
                if (newStatus === 'done') {
                    updateData.deadline = `Conclu√≠do: ${new Date().toLocaleDateString('pt-BR')}`;
                } else if (currentStatus === 'done') {
                    const currentDeadline = draggedItem.querySelector('.meta span:nth-child(2)').textContent.replace('Prazo: ', '');
                    updateData.deadline = currentDeadline;
                }
                await updateTask(taskId, updateData);
            }
        }
    });

    function getDragAfterElement(container, y) {
        const draggableElements = [...container.querySelectorAll('.kanban-task:not(.dragging)')];
        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
            } else {
                return closest;
            }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    // ####################### L√≥gica da IA Kaizen #######################

    function updateKaizenSuggestions(tasks) {
        kaizenSuggestions.innerHTML = ''; 

        const tasksByStatus = tasks.reduce((acc, task) => {
            acc[task.status] = acc[task.status] || [];
            acc[task.status].push(task);
            return acc;
        }, {});
        
        const todoTasks = tasksByStatus.todo || [];
        const doingTasks = tasksByStatus.doing || [];
        const doneTasks = tasksByStatus.done || [];

        // Sugest√£o: Checklist para tarefas sem respons√°vel
        const withoutResponsible = todoTasks.filter(t => !t.responsible);
        if (withoutResponsible.length > 0) {
            kaizenSuggestions.innerHTML += `<p>H√° ${withoutResponsible.length} tarefa(s) sem respons√°vel. Considere atribu√≠-las a algu√©m.</p>`;
        }
        
        // Sugest√£o: Cuidado com prazos
        const today = new Date();
        today.setHours(0,0,0,0);
        
        const overdueTasks = todoTasks.filter(task => {
            if (task.deadline) {
                try {
                    const [day, month, year] = task.deadline.split('/').map(Number);
                    const deadlineDate = new Date(year, month - 1, day);
                    return deadlineDate < today;
                } catch(e) {
                    return false;
                }
            }
            return false;
        });

        if (overdueTasks.length > 0) {
            kaizenSuggestions.innerHTML += `<p><strong>Aten√ß√£o:</strong> ${overdueTasks.length} tarefa(s) est√£o com o prazo vencido!</p>`;
        }

        // Sugest√£o: Reuni√£o para revisar gargalos
        if (doingTasks.length > 3 && doingTasks.length > todoTasks.length) {
            kaizenSuggestions.innerHTML += `<p>H√° muitos itens em "Fazendo". Isso pode indicar gargalos. Considere uma reuni√£o r√°pida para realinhar prioridades.</p>`;
        }

        // Sugest√£o: Celebrar conclus√µes
        if (doneTasks.length > 0) {
             kaizenSuggestions.innerHTML += `<p>√ìtimo trabalho! Lembre-se de celebrar as pequenas vit√≥rias da equipe. üéâ</p>`;
        }

        if (kaizenSuggestions.innerHTML === '') {
            kaizenSuggestions.innerHTML = '<p>Nenhuma sugest√£o Kaizen no momento. Continue o bom trabalho!</p>';
        }
    }

    // ####################### Fun√ß√µes para os bot√µes de navega√ß√£o #######################

    window.signOutUser = async function() {
        try {
            await window.signOut(window.auth);
            showModal('Sess√£o Encerrada', 'Voc√™ foi desconectado(a) com sucesso. Por favor, recarregue a p√°gina para acessar novamente.');
        } catch (error) {
            showModal('Erro ao Sair', error.message);
            console.error('Erro ao sair:', error);
        }
    }

    // ####################### Inicializa√ß√£o #######################

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('add-task-btn').addEventListener('click', () => {
            showModal('Adicionar Tarefa', 'Por favor, use os campos abaixo das colunas para adicionar uma nova tarefa.');
        });
        
        // Esconder menu de configura√ß√µes ao clicar fora
        window.addEventListener('click', (e) => {
            if (!e.target.closest('.settings-menu') && !e.target.closest('.kanban-task .actions button')) {
                document.querySelectorAll('.settings-menu').forEach(menu => menu.hidden = true);
            }
        });

        // Autentica e inicia a escuta do banco
        window.onAuthStateChanged(window.auth, (user) => {
            if (user) {
                authUser = user;
                const userId = authUser.uid;
                
                userInfoSpan.textContent = `Usu√°rio ID: ${userId}`;
                document.getElementById('board-title').textContent = `Quadro de Opera√ß√µes`;
                
                // Define a refer√™ncia da cole√ß√£o AP√ìS a autentica√ß√£o
                tasksCollectionRef = window.collection(window.db, `/artifacts/${appId}/users/${userId}/tasks`);
                
                // Real-time listener para a cole√ß√£o de tarefas
                window.onSnapshot(tasksCollectionRef, (querySnapshot) => {
                    const tasks = [];
                    querySnapshot.forEach((doc) => {
                        tasks.push({ id: doc.id, ...doc.data() });
                    });
                    renderTasks(tasks);
                });

            } else {
                console.log("Nenhum usu√°rio logado. Autenticando anonimamente.");
                window.authenticate();
            }
        });
    });

  </script>
