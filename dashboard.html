<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>integra+ Dashboard com Firestore</title>
  <meta name="description" content="Dashboard de gestão do integra+ com Kanban (A Fazer, Fazendo, Feito), controle do gestor e IA Kaizen para melhoria contínua." />

  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, addDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    // Variáveis globais obrigatórias injetadas pelo ambiente Canvas
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // ####################### Inicialização do Firebase #######################
    setLogLevel('debug');
    
    window.firebaseApp = initializeApp(firebaseConfig);
    window.auth = getAuth(window.firebaseApp);
    window.db = getFirestore(window.firebaseApp);

    async function authenticate() {
        try {
            if (initialAuthToken) {
                await signInWithCustomToken(window.auth, initialAuthToken);
            } else {
                await signInAnonymously(window.auth);
            }
            console.log("Usuário autenticado no Firebase.");
        } catch (error) {
            console.error("Erro na autenticação:", error);
            window.showModal('Erro de autenticação.', error.message);
        }
    }
    window.authenticate = authenticate;

    // Exportar funções para o escopo global para serem usadas nos handlers onclick=""
    window.onAuthStateChanged = onAuthStateChanged;
    window.signOut = signOut;
    window.doc = doc;
    window.setDoc = setDoc;
    window.updateDoc = updateDoc;
    window.deleteDoc = deleteDoc;
    window.onSnapshot = onSnapshot;
    window.collection = collection;
    window.query = query;
    window.addDoc = addDoc;
  </script>

  <style>
    :root{
      --bg: #0b1020;
      --bg-soft: #121935;
      --card: #161e42;
      --text: #eaf0ff;
      --muted: #b9c2e0;
      --brand: #6ee7ff;  /* ciano */
      --accent: #8b5cf6; /* roxo */
      --success: #22c55e;
      --warn: #f59e0b;
      --danger: #ef4444;
      --radius: 14px;
      --shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      color:var(--text);
      background: var(--bg);
      line-height: 1.6;
      display: flex;
    }
    a{color:inherit;text-decoration:none}
    .container{width:min(1200px, 92%); margin:0 auto}
    header{
      position:sticky; top:0; z-index:50;
      backdrop-filter:saturate(1.2) blur(10px);
      background: linear-gradient(180deg, rgba(11,16,32,.9), rgba(11,16,32,.6));
      border-bottom:1px solid rgba(255,255,255,.06);
      padding:16px 0;
    }
    .main-wrapper {
        display: flex;
        flex: 1;
        overflow: hidden;
    }
    aside{
        width: 240px;
        background-color: var(--bg-soft);
        border-right: 1px solid rgba(255,255,255,.06);
        padding: 20px 0;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        flex-shrink: 0;
    }
    aside .brand {
        padding: 0 20px 20px;
        border-bottom: 1px solid rgba(255,255,255,.06);
        margin-bottom: 20px;
    }
    aside .nav-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 20px;
        color: var(--muted);
        transition: background-color .2s ease, color .2s ease;
    }
    aside .nav-item.active, aside .nav-item:hover {
        background-color: rgba(255,255,255,.08);
        color: var(--text);
    }
    aside .nav-item svg {
        width: 20px;
        height: 20px;
    }
    aside .footer-nav {
        margin-top: auto;
    }
    main{
        flex: 1;
        padding: 20px;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
    }
    .board-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    .board-header h1 {
        margin: 0;
        font-size: clamp(24px, 3vw, 36px);
    }
    .brand{display:flex; align-items:center; gap:12px; font-weight:800; letter-spacing:.5px}
    .logo{
      width:34px;height:34px;border-radius:8px;
      background: conic-gradient(from 90deg, var(--brand), var(--accent));
      display:grid; place-items:center;
      box-shadow: 0 6px 18px rgba(110,231,255,.35), inset 0 0 12px rgba(139,92,246,.35);
      position:relative; overflow:hidden;
    }
    .logo::after{
      content:"+"; font-weight:800; color:#001014; font-size:22px;
      text-shadow: 0 1px 0 rgba(255,255,255,.35);
    }
    .btn{
      display:inline-flex; align-items:center; gap:10px;
      padding:12px 16px; border-radius:12px; border:1px solid rgba(255,255,255,.1);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      color:var(--text); font-weight:600; cursor:pointer;
      transition: transform .06s ease, box-shadow .2s ease, border-color .2s ease;
    }
    .btn:hover{transform: translateY(-1px); border-color: rgba(255,255,255,.22);}
    .btn.primary{
      background: linear-gradient(180deg, rgba(110,231,255,.20), rgba(139,92,246,.15));
      border-color: rgba(110,231,255,.55);
      box-shadow: 0 10px 28px rgba(14,165,233,.25);
    }
    .btn.small{padding:8px 12px; font-size:14px; border-radius:10px}

    /* Kanban Board */
    .kanban-board{
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      flex: 1;
    }
    .kanban-column{
      background: var(--bg-soft);
      border-radius: var(--radius);
      padding: 15px;
      display: flex;
      flex-direction: column;
    }
    .kanban-column h2{
      margin: 0 0 15px;
      font-size: 18px;
      color: var(--brand);
      border-bottom: 1px solid rgba(255,255,255,.1);
      padding-bottom: 10px;
    }
    .kanban-tasks{
      flex: 1;
      min-height: 100px;
      background-color: rgba(0,0,0,.05);
      border-radius: 8px;
      padding: 10px;
    }
    .kanban-task{
      background: var(--card);
      border: 1px solid rgba(255,255,255,.1);
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 10px;
      cursor: grab;
      box-shadow: 0 4px 12px rgba(0,0,0,.15);
      transition: transform .1s ease, box-shadow .1s ease;
      position: relative;
    }
    .kanban-task:active{
        cursor: grabbing;
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(0,0,0,.2);
    }
    .kanban-task.dragging {
      opacity: 0.5;
      border-style: dashed;
    }
    .kanban-task strong{
      display:block;
      margin-bottom: 4px;
    }
    .kanban-task .meta{
      font-size: 12px;
      color: var(--muted);
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }
    .kanban-task .meta span:first-child{
        flex-grow: 1;
    }
    .kanban-task .actions {
        display: flex;
        gap: 8px;
        margin-top: 10px;
    }
    .kanban-task .actions button {
        background: none;
        border: none;
        color: var(--muted);
        cursor: pointer;
        font-size: 14px;
        padding: 2px;
    }
    .kanban-task .actions button:hover {
        color: var(--text);
    }
    .kanban-task .actions button.delete:hover {
        color: var(--danger);
    }

    .add-task{
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px dashed rgba(255,255,255,.08);
    }
    .add-task input{
        width: 100%;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid rgba(255,255,255,.2);
        background: rgba(255,255,255,.05);
        color: var(--text);
        margin-bottom: 8px;
    }
    .add-task button{
        padding: 10px 14px;
        border-radius: 8px;
        border: none;
        background: var(--brand);
        color: var(--bg);
        font-weight: 600;
        cursor: pointer;
        width: 100%;
    }
    .add-task-btn-container {
      display: flex;
      justify-content: center;
    }

    /* IA Kaizen Section */
    .kaizen-ia {
        background: linear-gradient(180deg, rgba(139,92,246,.15), rgba(110,231,255,.10));
        border: 1px solid rgba(139,92,246,.3);
        border-radius: var(--radius);
        padding: 20px;
        margin-top: 20px;
        display: flex;
        gap: 15px;
        align-items: flex-start;
        box-shadow: 0 8px 24px rgba(139,92,246,.15);
    }
    .kaizen-ia .icon {
        font-size: 30px;
        line-height: 1;
        color: var(--accent);
    }
    .kaizen-ia h3 {
        margin: 0 0 8px;
        color: var(--brand);
    }
    .kaizen-ia p {
        margin: 0;
        font-size: 14px;
        color: var(--muted);
    }
    .kaizen-ia .suggestions {
        margin-top: 15px;
        border-top: 1px dashed rgba(255,255,255,.1);
        padding-top: 10px;
    }
    .kaizen-ia .suggestions p {
        margin-bottom: 5px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .kaizen-ia .suggestions p::before {
        content: "💡";
        font-size: 16px;
    }

    .settings-menu {
        position: absolute;
        top: 30px;
        right: 0;
        background-color: var(--card);
        border: 1px solid rgba(255,255,255,.1);
        border-radius: 8px;
        padding: 8px 0;
        box-shadow: var(--shadow);
        z-index: 10;
        min-width: 150px;
    }
    .settings-menu button {
        display: block;
        width: 100%;
        padding: 8px 15px;
        text-align: left;
        background: none;
        border: none;
        color: var(--text);
        cursor: pointer;
        font-size: 14px;
    }
    .settings-menu button:hover {
        background-color: rgba(255,255,255,.08);
    }

    .message-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }

    .modal-content {
        background-color: var(--bg-soft);
        border: 1px solid var(--card);
        border-radius: var(--radius);
        padding: 30px;
        max-width: 400px;
        text-align: center;
        width: 90%;
    }

    .modal-content h3 {
        margin-top: 0;
        font-size: 20px;
    }

    .modal-content p {
        margin-bottom: 20px;
        color: var(--muted);
    }
    
    .modal-content input {
        width: 100%;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid rgba(255,255,255,.2);
        background: rgba(255,255,255,.05);
        color: var(--text);
        margin-bottom: 8px;
    }

    .modal-actions {
        display: flex;
        gap: 10px;
        justify-content: center;
    }

    .modal-actions button {
        padding: 10px 20px;
        border-radius: 8px;
        border: 1px solid rgba(255,255,255,.2);
        background: var(--card);
        color: var(--text);
        cursor: pointer;
    }
    
    .other-views {
        padding: 20px;
        background-color: var(--bg-soft);
        border-radius: var(--radius);
        flex: 1;
        overflow-y: auto;
    }

    /* Responsive */
    @media (max-width: 900px){
      body {flex-direction: column;}
      aside {width: 100%; padding: 10px 0; border-right: none; border-bottom: 1px solid rgba(255,255,255,.06); flex-direction: row; justify-content: start; overflow-x: auto;}
      aside .brand {display: none;} /* Oculta a marca em telas pequenas */
      aside nav { display: flex; }
      aside .nav-item {padding: 8px 15px; flex-shrink: 0;}
      aside .footer-nav {margin-top: 0; display: flex; margin-left: auto;}
      main {padding: 15px;}
      .kanban-board {grid-template-columns: 1fr; gap: 15px;}
      .board-header {flex-direction: column; align-items: flex-start; gap: 10px;}
      .kaizen-ia {flex-direction: column;}
    }
  </style>
</head>
<body>
  <aside>
    <div class="brand">
      <span class="logo" aria-hidden="true"></span>
      <span>integra+</span>
    </div>
    <nav>
      <a href="#" class="nav-item active" data-view="kanban">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M9 4.5v15m6-15v15m-10.5-15h15a2.25 2.25 0 0 1 2.25 2.25v10.5a2.25 2.25 0 0 1-2.25 2.25h-15A2.25 2.25 0 0 1 2.25 17.25V6.75A2.25 2.25 0 0 1 4.5 4.5z" />
        </svg>
        <span>Meus Quadros</span>
      </a>
      <a href="#" class="nav-item" data-view="reports">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
          <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6a7.5 7.5 0 1 0 7.5 7.5h-7.5V6Z" />
          <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 10.5H21A7.5 7.5 0 0 0 13.5 3v7.5Z" />
        </svg>
        <span>Relatórios</span>
      </a>
      <a href="#" class="nav-item" data-view="company">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
          <path stroke-linecap="round" stroke-linejoin="round" d="M15 19.125A7.5 7.5 0 0 1 12 21.75c-2.41 0-4.706-.568-6.733-1.936m9.546-3.04A9 9 0 0 0 12 18.75c-2.305 0-4.47-.612-6.337-1.76M9 4.5L12 3m0 0l3 1.5M12 3v13.5m0-13.5L9 1.5M12 3L6.063 6.063M12 3l5.937 3.063m0 0L21 9m-9-6l-5.937 3.063M15 4.5v13.5m0 0l3 1.5m-3-1.5l-3-1.5m3 1.5l3-1.5M9 4.5v13.5m0 0l3 1.5m-3-1.5L6 18m3-1.5l-3-1.5m0 0l-5.937-3.063m11.874 0L21 9m-9-6h.008v.008H12V3Z" />
        </svg>
        <span>Geral da Empresa</span>
      </a>
    </nav>
    <div class="footer-nav">
        <a href="#" class="nav-item" data-view="settings">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.502c.55 0 1.02.398 1.11.94l.213 1.281c.061.365.331.644.68.784a1.864 1.864 0 0 0 1.606.275c.34-.142.6-.367.766-.622l1.28-1.281c.539-.539 1.399-.54 1.938 0 1.157 1.159 1.157 3.043 0 4.199l-1.281 1.28c-.255.166-.48.426-.622.766a1.864 1.864 0 0 0 .275 1.606c.14.349.42.619.785.68l1.28.213c.542.09.94.56.94 1.11v2.502c0 .55-.398 1.02-.94 1.11l-1.28.213c-.365.061-.644.331-.785.68a1.864 1.864 0 0 0-.275 1.606c.142.34.367.6.622.766l1.281 1.28c.539.539.54 1.399 0 1.938-1.159 1.157-3.043 1.157-4.199 0l-1.28-1.281c-.166-.255-.426-.48-.766-.622a1.864 1.864 0 0 0-1.606-.275c-.349.14-.619.42-.68.785l-.213 1.28c-.09.542-.56.94-1.11.94h-2.502c-.55 0-1.02-.398-1.11-.94l-.213-1.28c-.061-.365-.331-.644-.68-.785a1.864 1.864 0 0 0-1.606-.275c-.34.142-.6.367-.766.622l-1.28 1.281c-.539.539-1.399.54-1.938 0-1.157-1.159-1.157-3.043 0-4.199l1.281-1.28c.255-.166.48-.426.622-.766a1.864 1.864 0 0 0-.275-1.606c-.14-.349-.42-.619-.785-.68l-1.28-.213c-.542-.09-.94-.56-.94-1.11v-2.502c0-.55.398-1.02.94-1.11l1.28-.213c.365-.061.644-.331.785-.68a1.864 1.864 0 0 0 .275-1.606c-.142-.34-.367-.6-.622-.766l-1.281-1.28c-.539-.539-.54-1.399 0-1.938 1.159-1.157 3.043-1.157 4.199 0l1.28 1.281c.166.255.426.48.766.622a1.864 1.864 0 0 0 1.606.275c.349-.14.619-.42.68-.785l.213-1.28Z" />
              <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
            </svg>
            <span>Configurações</span>
        </a>
        <a href="#" class="nav-item" data-view="signout">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0 0 13.5 3h-6a2.25 2.25 0 0 0-2.25 2.25v13.5A2.25 2.25 0 0 0 6.75 21h6a2.25 2.25 0 0 0 2.25-2.25V15M12 9l3 3m0 0-3 3m3-3H2.25" />
            </svg>
            <span>Sair</span>
        </a>
    </div>
  </aside>

  <div class="main-wrapper" id="main-wrapper">
    <main id="main-content">
        <div id="kanban-view">
            <div class="board-header">
                <div>
                  <p style="margin:0; font-size:14px; color:var(--muted)">Bem-vindo(a), <span id="user-info">Carregando...</span></p>
                  <h1 id="board-title">Quadro de Operações</h1>
                </div>
                <button class="btn primary small" id="add-task-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" style="width:16px; height:16px;">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                    </svg>
                    Nova Tarefa
                </button>
            </div>

            <div class="kanban-board" id="kanban-board">
                <div class="kanban-column" id="column-todo">
                    <h2>A Fazer</h2>
                    <div class="kanban-tasks" data-status="todo"></div>
                    <div class="add-task">
                        <input type="text" placeholder="Tarefa..." id="new-task-title-todo">
                        <input type="text" placeholder="Responsável..." id="new-task-responsible-todo">
                        <input type="text" placeholder="Prazo (DD/MM/AAAA)..." id="new-task-deadline-todo">
                        <div class="add-task-btn-container">
                          <button onclick="addTask('todo')">Adicionar</button>
                        </div>
                    </div>
                </div>

                <div class="kanban-column" id="column-doing">
                    <h2>Fazendo</h2>
                    <div class="kanban-tasks" data-status="doing"></div>
                    <div class="add-task">
                        <input type="text" placeholder="Tarefa..." id="new-task-title-doing">
                        <input type="text" placeholder="Responsável..." id="new-task-responsible-doing">
                        <input type="text" placeholder="Prazo (DD/MM/AAAA)..." id="new-task-deadline-doing">
                        <div class="add-task-btn-container">
                          <button onclick="addTask('doing')">Adicionar</button>
                        </div>
                    </div>
                </div>

                <div class="kanban-column" id="column-done">
                    <h2>Feito</h2>
                    <div class="kanban-tasks" data-status="done"></div>
                    <div class="add-task">
                        <input type="text" placeholder="Tarefa..." id="new-task-title-done">
                        <input type="text" placeholder="Responsável..." id="new-task-responsible-done">
                        <input type="text" placeholder="Prazo (DD/MM/AAAA)..." id="new-task-deadline-done">
                        <div class="add-task-btn-container">
                          <button onclick="addTask('done')">Adicionar</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="kaizen-ia">
                <div class="icon">🤖</div>
                <div>
                    <h3>IA Kaizen recomendações:</h3>
                    <p>O integra+ está sempre buscando oportunidades de melhoria contínua para sua equipe.</p>
                    <div class="suggestions" id="kaizen-suggestions">
                        <p>Carregando recomendações...</p>
                    </div>
                    <button class="btn small primary" onclick="speakKaizenSuggestions()">Ouvir recomendações</button>
                </div>
            </div>
        </div>
        
        <div id="reports-view" class="other-views" style="display: none;">
            <h2>Relatórios de Produtividade</h2>
            <p style="color: var(--muted);">Aqui você pode visualizar gráficos e estatísticas sobre o progresso das tarefas da sua equipe.</p>
            <p><strong>Visão Geral da Empresa:</strong></p>
            <ul>
                <li>Gráfico de tarefas por status (A Fazer, Fazendo, Feito)</li>
                <li>Relatório de conclusão de tarefas ao longo do tempo</li>
                <li>Análise de gargalos (quem está com mais tarefas em "Fazendo")</li>
            </ul>
        </div>

        <div id="company-view" class="other-views" style="display: none;">
            <h2>Visão Geral da Empresa</h2>
            <p style="color: var(--muted);">Acompanhe o desempenho e a estrutura de sua equipe.</p>
            <p><strong>Detalhes da Organização:</strong></p>
            <ul>
                <li>Membros da equipe e suas atribuições.</li>
                <li>Histórico de projetos e metas alcançadas.</li>
                <li>Notificações e comunicados importantes.</li>
            </ul>
        </div>
        
        <div id="settings-view" class="other-views" style="display: none;">
            <h2>Configurações do Sistema</h2>
            <p style="color: var(--muted);">Gerencie as preferências e o seu perfil.</p>
            <p><strong>Ajustes e Personalização:</strong></p>
            <ul>
                <li>Configurações de notificação por e-mail.</li>
                <li>Opções de tema (claro/escuro).</li>
                <li>Gerenciamento de acesso e permissões.</li>
            </ul>
        </div>
    </main>
  </div>

  <div id="message-modal" class="message-modal">
      <div class="modal-content" id="modal-content">
          <h3 id="modal-title"></h3>
          <p id="modal-message"></p>
          <div class="modal-actions" id="modal-actions">
              <button id="modal-confirm-btn">Confirmar</button>
              <button id="modal-cancel-btn">Cancelar</button>
          </div>
      </div>
  </div>

  <script type="module">
    // ####################### Variáveis e Referências do DOM #######################
    const kanbanView = document.getElementById('kanban-view');
    const navItems = document.querySelectorAll('.nav-item');
    const kanbanBoard = document.getElementById('kanban-board');
    const messageModal = document.getElementById('message-modal');
    const modalContent = document.getElementById('modal-content');
    const modalTitle = document.getElementById('modal-title');
    const modalMessage = document.getElementById('modal-message');
    const modalActions = document.getElementById('modal-actions');
    const modalConfirmBtn = document.getElementById('modal-confirm-btn');
    const modalCancelBtn = document.getElementById('modal-cancel-btn');
    const kaizenSuggestions = document.getElementById('kaizen-suggestions');
    const userInfoSpan = document.getElementById('user-info');
    
    let draggedItem = null;
    let authUser = null;
    let tasksCollectionRef = null; 
    let unsubscribeFromTasks = null;
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    // ####################### Funções de UI e Acessibilidade #######################

    function renderView(viewName) {
        // Oculta todas as visualizações e remove a classe 'active'
        document.querySelectorAll('.other-views').forEach(view => view.style.display = 'none');
        kanbanView.style.display = 'none';
        navItems.forEach(item => item.classList.remove('active'));

        // Exibe a visualização correta
        const viewToShow = document.getElementById(`${viewName}-view`);
        if (viewToShow) {
            viewToShow.style.display = 'block';
            if (viewName === 'kanban') {
              kanbanView.style.display = 'block';
              viewToShow.style.display = 'contents';
            }
        }
        
        const navItem = document.querySelector(`[data-view="${viewName}"]`);
        if (navItem) {
            navItem.classList.add('active');
        }
    }

    // Função para mostrar um modal de mensagem ou confirmação
    window.showModal = function(title, message, isConfirm = false) {
        return new Promise(resolve => {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            messageModal.style.display = 'flex';
            modalConfirmBtn.textContent = 'OK';
            modalCancelBtn.style.display = 'none';

            if (isConfirm) {
                modalConfirmBtn.textContent = 'Confirmar';
                modalCancelBtn.style.display = 'inline-block';
            }
            
            modalConfirmBtn.onclick = () => {
                messageModal.style.display = 'none';
                resolve(true);
            };
            modalCancelBtn.onclick = () => {
                messageModal.style.display = 'none';
                resolve(false);
            };
        });
    }

    // Função para mostrar um modal de prompt com campo de texto
    window.showPromptModal = function(title, message, defaultValue = '') {
        return new Promise(resolve => {
            modalTitle.textContent = title;
            modalMessage.textContent = ''; // Limpa a mensagem padrão
            
            const existingInput = modalContent.querySelector('input');
            if(existingInput) existingInput.remove();
            
            const input = document.createElement('input');
            input.type = 'text';
            input.placeholder = message;
            input.value = defaultValue;
            modalContent.insertBefore(input, modalActions);
            
            modalConfirmBtn.textContent = 'Salvar';
            modalCancelBtn.style.display = 'inline-block';
            messageModal.style.display = 'flex';
            
            const onConfirm = () => {
                messageModal.style.display = 'none';
                input.remove();
                resolve(input.value);
            };
            
            const onCancel = () => {
                 messageModal.style.display = 'none';
                input.remove();
                resolve(null);
            };

            modalConfirmBtn.onclick = onConfirm;
            modalCancelBtn.onclick = onCancel;
            
            input.focus();
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') onConfirm();
                if (e.key === 'Escape') onCancel();
            });
        });
    };

    // Funcionalidade de voz
    const supportsSpeech = 'speechSynthesis' in window && 'SpeechSynthesisUtterance' in window;
    window.speak = function(text, rate=1){
      if(!supportsSpeech || !text) return;
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'pt-BR';
      const pickVoice = () => {
        const voices = speechSynthesis.getVoices();
        const br = voices.find(v => v.lang.toLowerCase().startsWith('pt-br'));
        if(br) u.voice = br;
        speechSynthesis.speak(u);
      };
      if(speechSynthesis.getVoices().length) pickVoice();
      else speechSynthesis.onvoiceschanged = pickVoice;
    }

    window.speakKaizenSuggestions = function(){
        let textToSpeak = 'Recomendações da Inteligência Artificial Kaizen. ';
        kaizenSuggestions.querySelectorAll('p').forEach(p => {
            textToSpeak += p.textContent + '. ';
        });
        speak(textToSpeak);
    }
    
    // ####################### Funções de Manipulação do DOM #######################
    
    function renderTasks(tasks) {
        const columns = {
            todo: document.querySelector('.kanban-tasks[data-status="todo"]'),
            doing: document.querySelector('.kanban-tasks[data-status="doing"]'),
            done: document.querySelector('.kanban-tasks[data-status="done"]')
        };

        // Limpa todas as colunas
        Object.values(columns).forEach(col => col.innerHTML = '');

        // Preenche as colunas com as tarefas do banco
        tasks.forEach(task => {
            const newTask = document.createElement('div');
            newTask.classList.add('kanban-task');
            newTask.setAttribute('draggable', 'true');
            newTask.setAttribute('data-id', task.id);
            newTask.setAttribute('data-status', task.status);

            const deadlineText = task.deadline ? `Prazo: ${task.deadline}` : 'Prazo: A definir';
            const responsibleText = task.responsible ? `Responsável: ${task.responsible}` : 'A definir';
            
            newTask.innerHTML = `
                <strong>${task.title}</strong>
                <div class="meta">
                    <span>${responsibleText}</span>
                    <span>${deadlineText}</span>
                </div>
                <div class="actions">
                    <button onclick="editTaskTitle(this)" title="Editar Título">✏️</button>
                    <button class="delete" onclick="deleteTask(this)" title="Excluir Tarefa">🗑️</button>
                    <button onclick="openSettings(this)" title="Mais Opções">⚙️</button>
                    <div class="settings-menu" hidden>
                        <button onclick="editTaskResponsible(this)">Atribuir Responsável</button>
                        <button onclick="editTaskDeadline(this)">Definir Prazo</button>
                    </div>
                </div>
            `;
            if (columns[task.status]) {
                 columns[task.status].appendChild(newTask);
            }
        });
        updateKaizenSuggestions(tasks);
    }

    function updateKaizenSuggestions(tasks) {
        let suggestions = [];
        const doingTasks = tasks.filter(t => t.status === 'doing');
        const todoTasks = tasks.filter(t => t.status === 'todo');
        const doneTasks = tasks.filter(t => t.status === 'done');

        if (doingTasks.length > 5) {
            suggestions.push("Há muitas tarefas em andamento. Considere focar em finalizar algumas antes de começar novas para evitar gargalos.");
        }
        if (todoTasks.length > 10 && doneTasks.length < 2) {
            suggestions.push("O backlog está crescendo. Que tal priorizar as tarefas mais importantes ou dividir tarefas grandes em menores?");
        }
        const overdueTasks = tasks.filter(t => {
            if (!t.deadline || t.status === 'done') return false;
            try {
                const parts = t.deadline.split('/');
                if (parts.length !== 3) return false;
                const [day, month, year] = parts;
                const deadlineDate = new Date(`${year}-${month}-${day}T23:59:59`);
                return deadlineDate < new Date();
            } catch(e) { return false; }
        });
        if(overdueTasks.length > 0) {
            suggestions.push(`Atenção! Existem ${overdueTasks.length} tarefa(s) com o prazo vencido. Revise os prazos ou priorize-as.`);
        }
        if (suggestions.length === 0) {
            suggestions.push("Tudo parece em ordem. Continue com o bom trabalho e mantenha o quadro atualizado!");
        }

        kaizenSuggestions.innerHTML = suggestions.map(s => `<p>${s}</p>`).join('');
    }
    
    // ####################### Funções de Interação com Firestore #######################
    
    window.addTask = async function(status) {
        if (!tasksCollectionRef) {
            showModal('Erro', 'Você precisa estar logado para adicionar tarefas.');
            return;
        }
        
        const titleInput = document.getElementById(`new-task-title-${status}`);
        const responsibleInput = document.getElementById(`new-task-responsible-${status}`);
        const deadlineInput = document.getElementById(`new-task-deadline-${status}`);

        const taskTitle = titleInput.value.trim();
        const taskResponsible = responsibleInput.value.trim();
        const taskDeadline = deadlineInput.value.trim();
        
        if (!taskTitle) {
            showModal('Erro', 'O título da tarefa é obrigatório.');
            return;
        }
        
        const newTask = {
            title: taskTitle,
            responsible: taskResponsible || null,
            deadline: taskDeadline || null,
            status: status,
            createdAt: new Date().toISOString()
        };
        
        try {
            await window.addDoc(tasksCollectionRef, newTask);
            titleInput.value = '';
            responsibleInput.value = '';
            deadlineInput.value = '';
        } catch (error) {
            showModal('Erro ao adicionar tarefa', error.message);
            console.error('Erro ao adicionar tarefa:', error);
        }
    }

    window.updateTask = async function(taskId, newData) {
        if (!authUser || !tasksCollectionRef) return;
        try {
            const taskDocRef = window.doc(tasksCollectionRef, taskId);
            await window.updateDoc(taskDocRef, newData);
        } catch (error) {
            showModal('Erro ao atualizar tarefa', error.message);
            console.error('Erro ao atualizar tarefa:', error);
        }
    }

    window.deleteTask = async function(button) {
        if (!authUser || !tasksCollectionRef) return;
        const taskId = button.closest('.kanban-task').getAttribute('data-id');
        const confirmDelete = await showModal('Confirmação', 'Tem certeza que deseja excluir esta tarefa?', true);
        if (confirmDelete) {
            try {
                const taskDocRef = window.doc(tasksCollectionRef, taskId);
                await window.deleteDoc(taskDocRef);
            } catch (error) {
                showModal('Erro ao excluir tarefa', error.message);
                console.error('Erro ao excluir tarefa:', error);
            }
        }
    }

    window.editTaskTitle = async function(button) {
        const taskElement = button.closest('.kanban-task');
        const taskId = taskElement.getAttribute('data-id');
        const currentTitle = taskElement.querySelector('strong').textContent;
        const newTitle = await showPromptModal('Editar Título', 'Novo título da tarefa:', currentTitle);
        if (newTitle !== null && newTitle.trim() !== '') {
            await updateTask(taskId, { title: newTitle.trim() });
        }
    }

    window.editTaskResponsible = async function(button) {
        const taskElement = button.closest('.kanban-task');
        const taskId = taskElement.getAttribute('data-id');
        const metaSpan = taskElement.querySelector('.meta span:first-child');
        const currentResponsible = metaSpan.textContent.replace('Responsável: ', '').replace('A definir', '').trim();
        const newResponsible = await showPromptModal('Atribuir Responsável', 'Nome do responsável:', currentResponsible);
        if (newResponsible !== null) {
            await updateTask(taskId, { responsible: newResponsible.trim() || null });
        }
        taskElement.querySelector('.settings-menu').hidden = true;
    }

    window.editTaskDeadline = async function(button) {
        const taskElement = button.closest('.kanban-task');
        const taskId = taskElement.getAttribute('data-id');
        const metaSpan = taskElement.querySelector('.meta span:last-child');
        const currentDeadline = metaSpan.textContent.replace('Prazo: ', '').replace('A definir', '').trim();
        const newDeadline = await showPromptModal('Definir Prazo', 'Prazo (DD/MM/AAAA):', currentDeadline);
        if (newDeadline !== null) {
            await updateTask(taskId, { deadline: newDeadline.trim() || null });
        }
        taskElement.querySelector('.settings-menu').hidden = true;
    }

    window.openSettings = function(button) {
        const menu = button.nextElementSibling;
        const isHidden = menu.hidden;
        document.querySelectorAll('.settings-menu').forEach(m => m.hidden = true);
        if (isHidden) menu.hidden = false;
    }

    // ####################### Lógica Principal e Event Listeners #######################

    async function initializeApp() {
        await window.authenticate();

        window.onAuthStateChanged(window.auth, (user) => {
            if (user) {
                console.log("Usuário logado:", user.uid);
                authUser = user;
                const userId = user.uid;
                userInfoSpan.innerHTML = `Logado como: <span style="font-weight: bold; color: var(--brand);">${userId}</span>`;

                tasksCollectionRef = window.collection(window.db, `artifacts/${appId}/users/${userId}/tasks`);
                
                if (unsubscribeFromTasks) unsubscribeFromTasks();

                const q = window.query(tasksCollectionRef);
                unsubscribeFromTasks = window.onSnapshot(q, (snapshot) => {
                    const tasks = [];
                    snapshot.forEach((doc) => {
                        tasks.push({ id: doc.id, ...doc.data() });
                    });
                    tasks.sort((a,b) => (a.createdAt > b.createdAt) ? 1 : -1);
                    renderTasks(tasks);
                }, (error) => {
                    console.error("Erro ao buscar tarefas:", error);
                    showModal("Erro de Conexão", "Não foi possível carregar as tarefas.");
                });

            } else {
                console.log("Nenhum usuário logado.");
                authUser = null;
                tasksCollectionRef = null;
                if (unsubscribeFromTasks) unsubscribeFromTasks();
                renderTasks([]);
                userInfoSpan.textContent = 'Modo Público (anônimo)';
                showModal("Sessão Encerrada", "Você foi desconectado. Para salvar seu trabalho, recarregue a página para entrar novamente.");
            }
        });
    }

    async function signOutUser() {
        const confirm = await showModal('Sair', 'Tem certeza que deseja sair da sua conta?', true);
        if(!confirm) return;
        try {
            await window.signOut(window.auth);
            console.log("Usuário deslogado com sucesso.");
        } catch (error) {
            console.error("Erro ao sair:", error);
            showModal("Erro", "Não foi possível sair. Tente novamente.");
        }
    }
    
    // Listeners de Navegação
    navItems.forEach(item => {
        const view = item.dataset.view;
        item.addEventListener('click', (e) => {
            e.preventDefault();
            if (view === 'signout') {
                signOutUser();
            } else {
                renderView(view);
            }
        });
    });

    // Listener para o botão principal de adicionar tarefa
    document.getElementById('add-task-btn').addEventListener('click', () => {
        document.getElementById('new-task-title-todo').focus();
    });

    // Listeners de Drag and Drop (delegação de evento)
    kanbanBoard.addEventListener('dragstart', (e) => {
        if (e.target.classList.contains('kanban-task')) {
            draggedItem = e.target;
            setTimeout(() => e.target.classList.add('dragging'), 0);
        }
    });

    kanbanBoard.addEventListener('dragend', (e) => {
        if(draggedItem) {
           draggedItem.classList.remove('dragging');
           draggedItem = null;
        }
    });

    kanbanBoard.addEventListener('dragover', (e) => {
        e.preventDefault(); // Necessário para permitir o drop
    });

    kanbanBoard.addEventListener('drop', async (e) => {
        e.preventDefault();
        const column = e.target.closest('.kanban-tasks');
        if (column && draggedItem) {
            const newStatus = column.dataset.status;
            const taskId = draggedItem.dataset.id;
            if(draggedItem.dataset.status !== newStatus){
                await updateTask(taskId, { status: newStatus });
            }
        }
    });

    // Listener para fechar menus de contexto
    document.addEventListener('click', function(event) {
        if (!event.target.closest('.actions')) {
            document.querySelectorAll('.settings-menu').forEach(menu => {
                menu.hidden = true;
            });
        }
    });

    // Iniciar a aplicação
    document.addEventListener('DOMContentLoaded', initializeApp);
  </script>
</body>
</html>
